# 要件定義（Draft v1）

## 1. 目的

* WordPress 由来のブログを\*\*/blog 配下に限定\*\*して完全保存し、**JS依存含め当時の表示を再現**できる形で公開する。
* 既存WPサーバ停止後も**リンク切れ最小**で参照可能にする。
* 運用は\*\*静的ホスティング（Cloudflare Pages +（必要に応じて）R2）\*\*で完結させる。

## 2. 対象・範囲

* 対象サイト：`https://hidemiyoshi.jp/blog/` 配下（サブパス固定）
* 範囲：

  * 記事ページ、カテゴリ/タグ、月別アーカイブ、ページネーション、添付ファイル（`/wp-content/uploads/` 由来の画像等）
  * **ドメイン外CDN**（画像・CSS・JS）は「ページ再現に必要な分のみ」収集対象（WARCが自動で取り込む）
* **除外**：

  * `/wp-admin/`, `/wp-login.php`, `/feed/`, `/xmlrpc.php`, 検索結果の無限遷移など管理・API系
  * /blog 以外（トップや固定ページなど）は原則対象外（※必要なら第二フェーズで個別追加）

## 3. 成果物

* アーカイブファイル：**WACZ（1～複数個）**
* 公開UI：**ReplayWeb.page（単一HTML/JS）** をベースにした再生UI
* デプロイ一式：

  * Cloudflare Pages プロジェクト（`/` で再生UI、`/archives/*.wacz` を静的配備 or R2）
  * `_redirects`（任意）：旧URLからアーカイブUI or 新運用（Note）への誘導
* ドキュメント：

  * クロール設定（seeds, scope など）
  * 取得ログ／簡易レポート（URL件数、失敗件数、代表的な未取得リソースの一覧）

## 4. 非機能要件

* **再現性**：主要記事が**オフライン同等**で表示できる（外部参照のライブ依存が残らないのが理想）
* **可用性**：Cloudflare Pages で配布、容量が大きくなれば **R2 + Access-Control** でWACZ配信
* **保守性**：再クロール手順が自動化され、同設定で再現可能（Docker 1コマンド）
* **法務/倫理**：自社/本人管理のサイトである前提。外部由来アセット／コメント／埋め込みの扱いは利用規約上問題がないことを明確化。必要に応じて robots / noindex を設定。

## 5. 受け入れ基準（Acceptance Criteria）

1. **URL網羅**

   * `/blog/` 配下の**全記事**（公開ステータスのもの）がWACZに含まれること
   * サイトマップ／カテゴリ／月別アーカイブ／ページネーションから辿れるURLが**クロールレポート上でN件±5%以内**に収束
2. **再生品質**

   * ランダムサンプル **30件**で「記事本文・画像・スタイル・記事内リンク」が**破綻なく表示**される
   * jQuery等のリサイズ・ギャラリー挙動など**JS依存が再現**できている（代替表示に落ちない）
3. **外部依存**

   * 記事表示に**オンライン外部CDNが不可欠**となるケースが**10%未満**（WARCに取り込めていること）
4. **公開**

   * Cloudflare Pages 上で **トップ＝再生UI**、**WACZ参照可能**、Note への導線（リンク/バナー）あり
5. **再現手順**

   * README の手順で**クリーン環境から再WACZ生成→再デプロイ**が成功

---

# アーキテクチャ / 技術選定

## 1) 収集：**browsertrix-crawler（Webrecorder）**

* ヘッドレスChromeで**レンダリング後のネットワーク**をWARC化 → **WACZ**（WARC in ZIP + index）
* `/blog/` **prefixスコープ**でドメイン内回遊。**外部CDN**はページ再現に必要な範囲のみ取得
* Seeds：

  * `/blog/` ルート
  * サイトマップ（あれば）、カテゴリ一覧、月別アーカイブ一覧、ページネーションの典型パターン
* 設定要点：

  * `scopeType: "prefix"` + `urlFilters` で `/blog/` を明示
  * `generateWACZ: true`
  * `extraHeaders` や `waitUntil: networkidle`、`pageLoadDelay` で描画安定化
  * スクロールやクリック探索は `behaviors` で軽く有効化（ただし無限沼は回避）

## 2) 配信：**ReplayWeb.page + Cloudflare Pages/R2**

* **UI**：`index.html` に ReplayWeb.page を取り込み、指定の `.wacz` を読み込むだけ
* **格納**：

  * WACZ が小さい：**Pages の静的配備**でOK
  * WACZ が大きい：**R2 に配置 → CORS 設定 → Pages から参照**
* **カスタムUI**：記事一覧（WACZ内の `summary.json` 等）を読み、簡易 TOC を出すことも可能（任意）

## 3) デプロイ構成（例）

```
/               -> index.html（Replay UI）     [Pages]
/archives/*.wacz -> アーカイブ本体              [Pages or R2]
```
